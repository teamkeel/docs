# Using Clerk as an External Auth Provider with Keel

Clerk is a complete authentication and user management solution, providing an out of the box suite of APIs, UI components, and administration tools to manage users.

Keel, a similarily feature-packed platform (a swiss army knife), is an all-in-one backend platform, allowing you to build backends rapidly.

In this guide, you will learn how to integrate Clerk as an [external authentication provider](https://docs.keel.so/authentication/getting-started) in Keel, within a few minutes.

## Prerequisites

Before completing this guide, you should have:

- A [Clerk account](https://dashboard.clerk.com/)
- A [Keel account](https://console.keel.so/)
- [Node.js](https://nodejs.org/en) installed locally
- [Keel CLI](https://console.keel.so/) installed locally
- [Docker](https://docs.docker.com/desktop) installed locally

## Setting Up the Project

For this guide we will setup a simple Next.js [CRUD](keelconfig.yaml
) application, that will integrate both Clerk and Keel under the hood.

Start by initialising a project in your terminal with:

```sh
npx create-next-app@latest
```

Answer the questions prompted as follows:

```sh
✔ What is your project named? … <keel-clerk-demo>
✔ Would you like to use TypeScript? … <Yes>
✔ Would you like to use ESLint? … <Yes>
✔ Would you like to use Tailwind CSS? … <Yes>
✔ Would you like to use `src/` directory? … <Yes>
✔ Would you like to use App Router? (recommended) … <Yes>
✔ Would you like to customize the default import alias (@/*)? … <No>
```

Change the directory to the project you created.

```sh
cd keel-clerk-demo
```

Your folder structure should now look like this:

```sh
├── next.config.mjs
├── next-env.d.ts
├── node_modules
├── package.json
├── package-lock.json
├── postcss.config.js
├── public
├── README.md
├── src
├── tailwind.config.ts
└── tsconfig.json
```

Now, initialize a Keel project:

```sh
npx keel init
```

Enter the directory where you want the project to be created. The project will be nested under the Next.js app.

```sh
Directory 
✔ Where should we create your project?: |./keel
```

Choose `Blank project`.

```sh
How would you like to start your new project?
  Starter template
  <Blank project>
```
Follow the next steps like initialising a Git repo in your project, which is required for deploying to Keel.

This will create a new Keel project, inside the Next.js app source directory.

## Configuring Clerk

Navigate to your [Clerk Dashboard](https://dashboard.clerk.com/) and [**Create a new application**](https://dashboard.clerk.com/apps/new).

Enter an `Application name`. For example, `keel-clerk-demo`.

![Clerk's new application creation wizard](https://i.imgur.com/D3GM2w3.png)

Press **Create application**.

Open your terminal window and install the Clerk library.

```sh npm2yarn
npm install @clerk/nextjs
```

At your project's root, create a `.env` file. Copy the contents from the environment variables section shown on the image to the `.env` file.

![Clerk's environment variables shown in the dashboard](https://imgur.com/cMOMIBZ)

Your `.env` file should look something like this.

```env filename='.env'
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_123
CLERK_SECRET_KEY=sk_test_123
```

Now, under the **Configure** section of the Clerk Dashboard, choose **JWT Templates**. Press **New template**.

![JWT Templates section of the Clerk Dashboard shown](https://i.imgur.com/qt2guRR.png)

Choose a template name, for example `keel`.

In the `Claims` code field, paste the following snippet

![A newly create JWT template shown.](https://i.imgur.com/PjgFk5v.png)

Press **Save changes** in the top-right corner.

## Setting Up a Demo App

### Configuring Keel

We will create a simple model with all CRUD actions, that also utilises Keel's [`@permission` attribute](https://docs.keel.so/permissions#permission-attribute).

Back in your project, open the `keel.schema` file from the `keel` folder

Create a `Thing` model with `name` and `identity` fields.

```keel filename="keel/keel.schema"
model Thing {
    fields {
        name Text
        identity Identity
    }
}
```

Next, create the `getThing` and `createThing` actions, respectively.

```keel {6-12} filename="keel/keel.schema"
model Thing {
    fields {
        name Text
        identity Identity
    }
    actions {
        get getThing(id)
        create createThing() with (name) {
            @set(thing.identity = ctx.identity)
            @permission(expression: ctx.isAuthenticated)
        }
    }
}
```

The `@set` attribute in the `createThing` action will assign the `thing`'s identity to the `ctx` (context) identity. Similarily, the `@permission` attribute will only allow actions if the user is autenticated in the context.

Add the rest of actions.

```keel {13-17} filename="keel/keel.schema"
model Thing {
    fields {
        name Text
        identity Identity
    }
    actions {
        get getThing(id)
        create createThing() with (name) {
            @set(thing.identity = ctx.identity)
            @permission(expression: ctx.isAuthenticated)
        }
    }
    update updateThing(id) with (name)
    list myThings() {
        @where(thing.identity == ctx.identity)
    }
    delete deleteThing(id)
}
```
Finally, let's add the general `@permission` attribute. In the `action` selector, we will include all actions previously defined, which will be 'caught' by the authorisation check.

The `expression`'s value, or the value that needs to be met for successful authorisation, is that `thing`'s identity must match the `ctx`'s identity.

```keel filename="keel/keel.schema"
model Thing {
    fields {
        name Text
        identity Identity
    }
    actions {
        get getThing(id)
        create createThing() with (name) {
            @set(thing.identity = ctx.identity)
            @permission(expression: ctx.isAuthenticated)
        }
    }
    update updateThing(id) with (name)
    list myThings() {
        @where(thing.identity == ctx.identity)
    }
    delete deleteThing(id)

    @permission(
        actions: [list, get, update, delete],
        expression: thing.identity == ctx.identity
    )
}
```

That's it for the `keel.schema` file. Now, let's edit the `keelconfig.yaml` file.

At the end of the file, add the `providers` object with the following details.

```yaml filename="keel/keelconfig.yaml"
auth:
  providers:
    - type: oidc
      name: clerk
      issuerUrl: "https://keel-is-great.clerk.accounts.dev" # Your Clerk url
      clientId: "keel" # Must match the Clerk JWT aud claim
```

The `clientId` must match the `aud` claim in the JWT template we set up previously.

The `issuerUrl` is found in the **Domains** section of the [Clerk Dashboard](https://dashboard.clerk.com).

![Domains shown in the Clerk Dashboard](https://i.imgur.com/I9N2gbG.png)

After completing this, you're done with the Keel's backend part. Now, generate the Keel client, which we'll later use in the Next.js app.

```sh
npx keel client
```

### Creating a Keel Auth Provider in Next.js

Now, we'll create a contextual provider that will perform the authentication flow between Clerk and Keel.

First, install the [`@teamkeel/client-react` library](https://www.npmjs.com/package/@teamkeel/client-react).

```sh npm2yarn
npm install @teamkeel/client-react
```

Next, create a new file `index.tsx` in the `src/app/keel` folder.

Import the dependencies.

```tsx filename="src/app/keel/index.tsx"
"use client"

import { useAuth } from "@clerk/nextjs";
import { keel } from "@teamkeel/client-react";
import { PropsWithChildren, useEffect, useState } from "react";
import { APIClient } from "../../../keel/keelClient";
export const { KeelProvider, useKeel } = keel(APIClient)
```

Create a `KeelAuthProvider` component, which will serve as an authentication state provider to the rest of the app. In the component, we will take the `auth` property from the `useKeel()` hook, as well as properties from the `useAuth()` - provided by Clerk. The component will store the authentication in a simple `useState()` with the `authenticated` property.

```tsx {9-13} filename="src/app/keel/index.tsx"
"use client"

import { useAuth } from "@clerk/nextjs";
import { keel } from "@teamkeel/client-react";
import { PropsWithChildren, useEffect, useState } from "react";
import { APIClient } from "../../../keel/keelClient";
export const { KeelProvider, useKeel } = keel(APIClient)

const KeelAuthProvider = (props: PropsWithChildren) => {
    const { auth } = useKeel()
    const { getToken, sessionId } = useAuth();
    const [authenticated, setAuthenticated] = useState(false);
}
```
Next, with the `useEffect()` hook, we will perform the ID token exchange and update the authentication state based on the response. Keel has a built-in function that does the token exchange on its behalf.

```tsx {14-25} filename="src/app/keel/index.tsx"
"use client"

import { useAuth } from "@clerk/nextjs";
import { keel } from "@teamkeel/client-react";
import { PropsWithChildren, useEffect, useState } from "react";
import { APIClient } from "../../../keel/keelClient";
export const { KeelProvider, useKeel } = keel(APIClient)

const KeelAuthProvider = (props: PropsWithChildren) => {
    const { auth } = useKeel()
    const { getToken, sessionId } = useAuth();
    const [authenticated, setAuthenticated] = useState(false);

    useEffect(() => {
        const token = async () => {
            const t = await getToken({ template: "keel" });
            await auth.authenticateWithIdToken(t!)
            const isAuthenticated = await auth.isAuthenticated()
            setAuthenticated(isAuthenticated)
        };
        token();
    }, [getToken, sessionId, auth]);
    return <>
        {props.children}
    </>
}
```
import { Callout } from "@core/callout"

<Callout type="info">
The `template` value in the `getToken()` function must match the JWT Template name we previously created in Clerk Dashboard.
</Callout>

Lastly, export the component.

```tsx {27} filename="src/app/keel/index.tsx"
"use client"

import { useAuth } from "@clerk/nextjs";
import { keel } from "@teamkeel/client-react";
import { PropsWithChildren, useEffect, useState } from "react";
import { APIClient } from "../../../keel/keelClient";
export const { KeelProvider, useKeel } = keel(APIClient)

const KeelAuthProvider = (props: PropsWithChildren) => {
    const { auth } = useKeel()
    const { getToken, sessionId } = useAuth();
    const [authenticated, setAuthenticated] = useState(false);

    useEffect(() => {
        const token = async () => {
            const t = await getToken({ template: "keel" });
            await auth.authenticateWithIdToken(t!)
            const isAuthenticated = await auth.isAuthenticated()
            setAuthenticated(isAuthenticated)
        };
        token();
    }, [getToken, sessionId, auth]);
    return <>
        {props.children}
    </>
}
export default KeelAuthProvider;
```


Now, let's edit the `layout.tsx` file, to acommodate for the `ClerkProvider` and `KeelProvider`.

```tsx {21-38} filename="src/app/layout.tsx"
import { ClerkProvider, RedirectToSignIn, SignedIn, SignedOut } from "@clerk/nextjs";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import KeelAuthProvider from "./keel";
import { KeelProvider } from "./keel/keel";


const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <SignedIn>
        <KeelProvider baseUrl={process.env.API_BASE_URL!}>
          <KeelAuthProvider>
            <html>
              <body>
                {children}
              </body>
            </html>
          <KeelAuthProvider>
        </KeelProvider>
      </SignedIn>
      <SignedOut>
        <RedirectToSignIn />
      </SignedOut>
    </ClerkProvider>
  );
}
```
<Callout>
The `<ClerkProvider />` must wrap the whole app, followed by the neat `<SignedIn />` component that renders the content only when the user is signed in, in which the `<KeelProvider />` resides, followed by `<KeelAuthProvider />`. The exact structure is necessary, since the `<KeelAuthProvider />` is dependant on the `<KeelProvider />` and `<ClerkProvider />`.
</Callout>

In the `.env` file, add the `API_BASE_URL` variable. The endpoint is the base URL + the API name (if you haven't manually set an API name, the default is `api`). This URL can be found in the Keel web console or in the output of `keel run` in your terminal.

```env {3} filename=".env"
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_123
CLERK_SECRET_KEY=sk_test_123
API_BASE_URL="http://localhost:8000/api"
```

### Creating CRUD Functionality in the App

Import dependencies.

```tsx filename="src/app/page.tsx"
"use client"
import { useCallback, useEffect, useState } from "react";
import { Thing } from "../../keel/keelClient";
import { useKeel } from "./keel";
```

Create the `<Home />` component. Begin with creating a `useState()` hook for manpiulating `things`. Then, destructure `api`  and `auth` methods from the `useKeel()` hook.

With a `useCallback()` hook, and using Keel's API query, we fetch `myThings` and update the state accordingly.

```tsx {7-21} filename="src/app/page.tsx"
"use client"
import { useAuth } from "@clerk/nextjs";
import { useCallback, useEffect, useState } from "react";
import { Thing } from "../../keel/keelClient";
import { useKeel } from "./keel";

export default function Home() {
  const [things, setThings] = useState<Thing[]>([]);
  const { api, auth } = useKeel();
  const isAuthenticated = auth.isAuthenticated;
  const fetchThings = useCallback(() => {
    api.queries.myThings().then((res) => {
      if (res.error) {
        console.error(res.error);
      }
      if (res.data) {
        setThings(res.data.results);
      }
    });
  }, [api]);
}
```
Next, with the `useEffect()` hook we want to fetch things on page load, and subsequent page rehydrations. We also add the `handleSubmit` that adds `things` to Keel using the API query.

```tsx {25-37} filename="src/app/page.tsx"
"use client"
import { useAuth } from "@clerk/nextjs";
import { useCallback, useEffect, useState } from "react";
import { Thing } from "../../keel/keelClient";
import { useKeel } from "./keel";

export default function Home() {
  const [things, setThings] = useState<Thing[]>([]);
  const { keel, authenticated } = useKeel();

  const [things, setThings] = useState<Thing[]>([]);
  const { api, auth } = useKeel();
  const isAuthenticated = auth.isAuthenticated;
  const fetchThings = useCallback(() => {
    api.queries.myThings().then((res) => {
      if (res.error) {
        console.error(res.error);
      }
      if (res.data) {
        setThings(res.data.results);
      }
    });
  }, [api]);

  useEffect(() => {
    if (!isAuthenticated) return;
    fetchThings();
  }, [isAuthenticated, fetchThings]);

  const handleSubmit: React.FormEventHandler<HTMLFormElement> = (e) => {
    e.preventDefault();
    api.mutations
      .createThing({
        name: e.currentTarget.thing.value,
      })
      .then(() => fetchThings());
  };
}
```
Finally, handle the UI with simple HTML elements.

```tsx {39-58} filename="src/app/page.tsx"
"use client"
import { useAuth } from "@clerk/nextjs";
import { useCallback, useEffect, useState } from "react";
import { Thing } from "../../keel/keelClient";
import { useKeel } from "./keel";

export default function Home() {
  const [things, setThings] = useState<Thing[]>([]);
  const { keel, authenticated } = useKeel();

  const [things, setThings] = useState<Thing[]>([]);
  const { api, auth } = useKeel();
  const isAuthenticated = auth.isAuthenticated;
  const fetchThings = useCallback(() => {
    api.queries.myThings().then((res) => {
      if (res.error) {
        console.error(res.error);
      }
      if (res.data) {
        setThings(res.data.results);
      }
    });
  }, [api]);

  useEffect(() => {
    if (!isAuthenticated) return;
    fetchThings();
  }, [isAuthenticated, fetchThings]);

  const handleSubmit: React.FormEventHandler<HTMLFormElement> = (e) => {
    e.preventDefault();
    api.mutations
      .createThing({
        name: e.currentTarget.thing.value,
      })
      .then(() => fetchThings());
  };

  return (
    <>
      <h1>Welcome</h1>
      <p>Here are your things</p>
      <ul>
        {things.map((thing) => (
          <li key={thing.id}>{thing.name}</li>
        ))}
      </ul>

      <hr />

      <form onSubmit={handleSubmit}>
        <div className="fields">
          <input name="thing" type="text" />
          <button type="submit">Add thing</button>
        </div>
      </form>
    </>
  );
}
```
To ensure Clerk does it job right, we need to create a middleware for Next.js to use. This is straight from Clerk's example and doesn't need modifications for this purpose.

```tsx filename="src/middleware.ts"
import { authMiddleware } from "@clerk/nextjs";

// See https://clerk.com/docs/references/nextjs/auth-middleware
// for more information about configuring your Middleware
export default authMiddleware({
  // Allow signed out users to access the specified routes:
  // publicRoutes: ['/anyone-can-visit-this-route'],
});

export const config = {
  matcher: [
    // Exclude files with a "." followed by an extension, which are typically static files.
    // Exclude files in the _next directory, which are Next.js internals.
    "/((?!.+\\.[\\w]+$|_next).*)",
    // Re-include any files in the api or trpc folders that might have an extension
    "/(api|trpc)(.*)",
  ],
};
```
## Testing the App

To run the app, running the following commands in the root of your project.

```sh
npm run dev # To start the CRUD app.
```

```sh
cd keel # Change the directory to keel
```

```sh
keel run # To start the Keel API
```
In your browser, navigate to the Next.js local host.

```sh
➜ npm run dev

> clerk@0.1.0 dev
> next dev

   ▲ Next.js 14.1.4
   - Local:        http://localhost:3000
   - Environments: .env.local
```

Next, sign up (or sign in) with Clerk.
![Clerk's login page shown within the app](https://i.imgur.com/DsuoeFf.png)

Try adding things with the input.
![App's input functionality shown.](https://i.imgur.com/59zwjRW.gif)

Navigating to the Keel Console and taking a look at the `thing` table in the **Database**, we'll see the added things. 
![Thing table shown in the Keel Console's Database view](https://i.imgur.com/gIb41Ff.png